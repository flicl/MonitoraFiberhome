zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 7df96b18c230490a9a0a9e2307226338
      name: 'Templates/Network Devices'
  templates:
    - uuid: a308b3e8c9b24466b041695503434691
      template: Template_OLT_Fiberhome_RP1000
      name: 'Template OLT Fiberhome RP1000'
      description: |
        Template para monitoramento de OLTs Fiberhome RP1000+ (AN5116-06B / AN5516-01)
        
        Requer scripts externos em /usr/lib/zabbix/externalscripts/:
        - fiberhome/fiberhome_olt_status.py (Master Item - Status)
        - fiberhome/fiberhome_olt_signals.py (Master Item - Sinais)
        - fiberhome/fiberhome_olt_lld.py (LLD PON + Status)
        - fiberhome/fiberhome_olt_interfaces.py (LLD Interfaces Físicas)
        - fiberhome_olt_status.py (Wrapper)
        - fiberhome_olt_signals.py (Wrapper)
        - fiberhome_olt_lld.py (Wrapper)
        - fiberhome_olt_interfaces.py (Wrapper)
        
        Macros obrigatórias:
        {$OLT_USER} - Usuário Telnet
        {$OLT_PASSWORD} - Senha Telnet
        {$OLT_PORT} - Porta Telnet (padrão 23)
        {$SNMP_COMMUNITY} - Comunidade SNMP
        {$SNMP_PORT} - Porta SNMP (padrão 161)
        
        Arquitetura:
        - Master Items (EXTERNAL) → retornam JSON
        - Dependent Items → extraem valores via JSONPath
        - Zero zabbix_sender, zero cron
      groups:
        - name: 'Templates/Network Devices'
      items:
        - uuid: 482093714ed940d1b2f0760dc7643d0b
          name: 'Fan Status'
          type: SNMP_AGENT
          snmp_oid: .1.3.6.1.4.1.5875.800.3.60.2.1.1.21
          key: fanAlarmStatus
          delay: '300'
          history: 7d
          trends: 30d
          tags:
            - tag: Application
              value: Chassi
        - uuid: b2c3d4e5f6784901a2b3c4d5e6f78901
          name: 'OLT Signals - Master Item'
          type: EXTERNAL
          key: 'fiberhome_olt_signals.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
          delay: 2h
          history: 7d
          value_type: TEXT
          trends: '0'
          tags:
            - tag: Application
              value: 'Fiberhome Overview'
        - uuid: a1b2c3d4e5f6478590a1b2c3d4e5f678
          name: 'OLT Status - Master Item'
          type: EXTERNAL
          key: 'fiberhome_olt_status.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
          delay: 6m
          history: 7d
          value_type: TEXT
          trends: '0'
          tags:
            - tag: Application
              value: 'Fiberhome Overview'
        - uuid: fb1fdb69d09846628ffa80cf45d2223c
          name: 'Clientes Total OLT'
          type: SNMP_AGENT
          snmp_oid: .1.3.6.1.4.1.5875.800.3.9.4.6.0
          key: onuCount
          delay: 60s
          history: 90d
          value_type: FLOAT
          tags:
            - tag: Application
              value: ONU
        - uuid: e76eb912226f46b09308a1bde517a6be
          name: Descrição
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.2.1.1.1.0
          key: sysDescr.0
          delay: '3600'
          history: 30d
          value_type: CHAR
          trends: '0'
          tags:
            - tag: Application
              value: Chassi
        - uuid: f5652488bd08442b82b6122b3cee2f42
          name: 'Temperatura da OLT'
          type: SNMP_AGENT
          snmp_oid: .1.3.6.1.4.1.5875.800.3.9.4.5.0
          key: sysTemperature
          delay: '30'
          history: 7d
          trends: 30d
          units: º
          tags:
            - tag: Application
              value: Chassi
        - uuid: 7c656518a8fa4128b876e3a6eb24ccd8
          name: 'Uptime da OLT'
          type: SNMP_AGENT
          snmp_oid: 1.3.6.1.2.1.1.3.0
          key: sysUpTimeInstance
          delay: '30'
          history: 7d
          trends: 30d
          units: uptime
          preprocessing:
            - type: MULTIPLIER
              parameters:
                - '0.01'
          tags:
            - tag: Application
              value: Chassi
        - uuid: c5325854817d4760b298418302194372
          name: 'Total ONUs Offline (Global)'
          type: DEPENDENT
          key: TotalOntOffline
          delay: '0'
          history: 7d
          trends: 90d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.data.totals.offline
          master_item:
            key: 'fiberhome_olt_status.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
          tags:
            - tag: Application
              value: 'Fiberhome Overview'
        - uuid: 8784725350414777b7320092c2539074
          name: 'Total ONUs Online (Global)'
          type: DEPENDENT
          key: TotalOntOnline
          delay: '0'
          history: 7d
          trends: 90d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.data.totals.online
          master_item:
            key: 'fiberhome_olt_status.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
          tags:
            - tag: Application
              value: 'Fiberhome Overview'
        - uuid: 4024328594244908ba67142445831557
          name: 'Total ONUs Provisionadas (Global)'
          type: DEPENDENT
          key: TotalOntProvisioned
          delay: '0'
          history: 7d
          trends: 90d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.data.totals.provisioned
          master_item:
            key: 'fiberhome_olt_status.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
          tags:
            - tag: Application
              value: 'Fiberhome Overview'
      discovery_rules:
        - uuid: 0f5aa4c3e514423bb269966bf39802fb
          name: 'Network Interfaces Discovery'
          type: EXTERNAL
          key: 'fiberhome_olt_interfaces.py[{HOST.CONN},{$SNMP_COMMUNITY},{$SNMP_PORT}]'
          delay: 1d
          filter:
            evaltype: AND
            conditions:
              - macro: '{#IFTYPE}'
                value: 6|62|117
                formulaid: A
          lifetime: 30d
          enabled_lifetime_type: DISABLE_NEVER
          description: 'Discovering physical ethernet interfaces from IF-MIB. Only ethernet (6, 62, 117) interfaces are monitored.'
          item_prototypes:
            - uuid: a1b2c3d4e5f6478590a1b2c3d4e5f679
              name: 'Interface {#IFNAME}: Bits received'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.31.1.1.1.6.{#SNMPINDEX}'
              key: 'net.if.in[ifHCInOctets.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              trends: 90d
              units: bps
              description: |
                MIB: IF-MIB
                The total number of octets received on the interface, including framing characters.
                This object is a 64-bit version of ifInOctets.
              preprocessing:
                - type: CHANGE_PER_SECOND
                  parameters:
                    - ''
                - type: MULTIPLIER
                  parameters:
                    - '8'
              tags:
                - tag: Application
                  value: 'Network Interfaces'
            - uuid: b2c3d4e5f6784901a2b3c4d5e6f78902
              name: 'Interface {#IFNAME}: Bits sent'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.31.1.1.1.10.{#SNMPINDEX}'
              key: 'net.if.out[ifHCOutOctets.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              trends: 90d
              units: bps
              description: |
                MIB: IF-MIB
                The total number of octets transmitted out of the interface, including framing characters.
                This object is a 64-bit version of ifOutOctets.
              preprocessing:
                - type: CHANGE_PER_SECOND
                  parameters:
                    - ''
                - type: MULTIPLIER
                  parameters:
                    - '8'
              tags:
                - tag: Application
                  value: 'Network Interfaces'
            - uuid: 505a4759b89146198bf3faae8590349c
              name: 'Interface {#IFNAME}: Speed'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.31.1.1.1.15.{#SNMPINDEX}'
              key: 'net.if.speed[ifHighSpeed.{#SNMPINDEX}]'
              delay: 5m
              history: 7d
              trends: '0'
              units: bps
              description: |
                MIB: IF-MIB
                An estimate of the interface's current bandwidth in units of 1,000,000 bits per second.
              preprocessing:
                - type: MULTIPLIER
                  parameters:
                    - '1000000'
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1h
              tags:
                - tag: Application
                  value: 'Network Interfaces'
            - uuid: cf50af1058074736836c94179b6162d5
              name: 'Interface {#IFNAME}: Operational status'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.2.2.1.8.{#SNMPINDEX}'
              key: 'net.if.status[ifOperStatus.{#SNMPINDEX}]'
              delay: 3m
              history: 7d
              trends: '0'
              description: |
                MIB: IF-MIB
                The current operational state of the interface.
                1 = up, 2 = down, 3 = testing, 4 = unknown, 5 = dormant, 6 = notPresent, 7 = lowerLayerDown
              valuemap:
                name: 'IF-MIB::ifOperStatus'
              tags:
                - tag: Application
                  value: 'Network Interfaces'
              trigger_prototypes:
                - uuid: 1b752338ebab4cf0a986d6608ecec699
                  expression: 'last(/Template_OLT_Fiberhome_RP1000/net.if.status[ifOperStatus.{#SNMPINDEX}])=2 and (last(/Template_OLT_Fiberhome_RP1000/net.if.status[ifOperStatus.{#SNMPINDEX}],#1)<>last(/Template_OLT_Fiberhome_RP1000/net.if.status[ifOperStatus.{#SNMPINDEX}],#2))'
                  recovery_mode: RECOVERY_EXPRESSION
                  recovery_expression: 'last(/Template_OLT_Fiberhome_RP1000/net.if.status[ifOperStatus.{#SNMPINDEX}])<>2'
                  name: 'Interface {#IFNAME}: Link down'
                  opdata: 'Current state: {ITEM.LASTVALUE1}'
                  priority: AVERAGE
                  description: 'Interface went down from up state.'
                  tags:
                    - tag: scope
                      value: availability
            - uuid: ed1f6c141aed446cb1a6a870ea25a08f
              name: 'Interface {#IFNAME}: Interface type'
              type: SNMP_AGENT
              snmp_oid: '1.3.6.1.2.1.2.2.1.3.{#SNMPINDEX}'
              key: 'net.if.type[ifType.{#SNMPINDEX}]'
              delay: 1h
              history: 7d
              trends: '0'
              description: |
                MIB: IF-MIB
                The type of interface. 6=ethernetCsmacd, 62=fastEther, 117=gigabitEthernet
              valuemap:
                name: 'IF-MIB::ifType'
              preprocessing:
                - type: DISCARD_UNCHANGED_HEARTBEAT
                  parameters:
                    - 1d
              tags:
                - tag: Application
                  value: 'Network Interfaces'
          graph_prototypes:
            - uuid: 0950ea30b0304062a6c5b3227f86e64f
              name: 'Interface {#IFNAME}: Network traffic'
              graph_items:
                - drawtype: GRADIENT_LINE
                  color: 199C0D
                  item:
                    host: Template_OLT_Fiberhome_RP1000
                    key: 'net.if.in[ifHCInOctets.{#SNMPINDEX}]'
                - sortorder: '1'
                  drawtype: BOLD_LINE
                  color: F63100
                  item:
                    host: Template_OLT_Fiberhome_RP1000
                    key: 'net.if.out[ifHCOutOctets.{#SNMPINDEX}]'
        - uuid: 2257007727144e59bf46162507663242
          name: 'PON Discovery'
          type: EXTERNAL
          key: 'fiberhome_olt_lld.py[{HOST.CONN},{$SNMP_COMMUNITY},{HOST.HOST},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT},{$SNMP_PORT}]'
          delay: 1h
          filter:
            evaltype: AND
            conditions:
              - macro: '{#PONNAME}'
                value: '.*'
                formulaid: A
          lifetime: 30d
          enabled_lifetime_type: DISABLE_NEVER
          item_prototypes:
            - uuid: 8c038374246440268584825946394235
              name: 'Melhor Sinal dBm - PON {#PONNAME}'
              type: DEPENDENT
              key: 'OntBestSinal.[{#PONNAME}]'
              delay: '0'
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.data.pon_signals
                - type: JAVASCRIPT
                  parameters:
                    - 'var arr = value; if (typeof arr === "string") { arr = JSON.parse(arr); } if (!Array.isArray(arr)) { return 0; } var targetPon = "{#PONNAME}"; for (var i = 0; i < arr.length; i++) { if (arr[i].pon_name == targetPon) { return Number(arr[i].best_signal); } } return 0;'
              master_item:
                key: 'fiberhome_olt_signals.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
              tags:
                - tag: Application
                  value: 'PON Signals'
            - uuid: 7c038374246440268584825946394236
              name: 'Média Sinal dBm - PON {#PONNAME}'
              type: DEPENDENT
              key: 'OntMediaSinal.[{#PONNAME}]'
              delay: '0'
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.data.pon_signals
                - type: JAVASCRIPT
                  parameters:
                    - 'var arr = value; if (typeof arr === "string") { arr = JSON.parse(arr); } if (!Array.isArray(arr)) { return 0; } var targetPon = "{#PONNAME}"; for (var i = 0; i < arr.length; i++) { if (arr[i].pon_name == targetPon) { return Number(arr[i].median_signal); } } return 0;'
              master_item:
                key: 'fiberhome_olt_signals.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
              tags:
                - tag: Application
                  value: 'PON Signals'
            - uuid: 4d038374246440268584825946394239
              name: 'ONUs Offline - PON {#PONNAME}'
              type: DEPENDENT
              key: 'OntOffline.[{#PONNAME}]'
              delay: '0'
              history: 7d
              trends: 90d
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.data.pon_ports
                - type: JAVASCRIPT
                  parameters:
                    - 'var arr = value; if (typeof arr === "string") { arr = JSON.parse(arr); } if (!Array.isArray(arr)) { return 0; } var targetPon = "{#PONNAME}"; for (var i = 0; i < arr.length; i++) { if (arr[i].pon_name == targetPon) { return Number(arr[i].offline); } } return 0;'
              master_item:
                key: 'fiberhome_olt_status.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
              tags:
                - tag: Application
                  value: 'PON Status'
            - uuid: 3d038374246440268584825946394240
              name: 'ONUs Online - PON {#PONNAME}'
              type: DEPENDENT
              key: 'OntOnline.[{#PONNAME}]'
              delay: '0'
              history: 7d
              trends: 90d
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.data.pon_ports
                - type: JAVASCRIPT
                  parameters:
                    - 'var arr = value; if (typeof arr === "string") { arr = JSON.parse(arr); } if (!Array.isArray(arr)) { return 0; } var targetPon = "{#PONNAME}"; for (var i = 0; i < arr.length; i++) { if (arr[i].pon_name == targetPon) { return Number(arr[i].online); } } return 0;'
              master_item:
                key: 'fiberhome_olt_status.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
              tags:
                - tag: Application
                  value: 'PON Status'
            - uuid: 6c038374246440268584825946394237
              name: 'Pior Sinal dBm - PON {#PONNAME}'
              type: DEPENDENT
              key: 'OntPoorSinal.[{#PONNAME}]'
              delay: '0'
              history: 7d
              value_type: FLOAT
              trends: 90d
              units: dBm
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.data.pon_signals
                - type: JAVASCRIPT
                  parameters:
                    - 'var arr = value; if (typeof arr === "string") { arr = JSON.parse(arr); } if (!Array.isArray(arr)) { return 0; } var targetPon = "{#PONNAME}"; for (var i = 0; i < arr.length; i++) { if (arr[i].pon_name == targetPon) { return Number(arr[i].poor_signal); } } return 0;'
              master_item:
                key: 'fiberhome_olt_signals.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
              tags:
                - tag: Application
                  value: 'PON Signals'
              trigger_prototypes:
                - uuid: 5c038374246440268584825946394238
                  expression: 'last(/Template_OLT_Fiberhome_RP1000/OntPoorSinal.[{#PONNAME}])>30'
                  name: 'Sinal Crítico (> -30dBm) na PON {#PONNAME}'
                  priority: HIGH
                  description: 'Pior sinal da PON está acima de 30dBm (perda alta).'
            - uuid: 2d038374246440268584825946394241
              name: 'ONUs Provisionadas - PON {#PONNAME}'
              type: DEPENDENT
              key: 'OntProvisioned.[{#PONNAME}]'
              delay: '0'
              history: 7d
              trends: 90d
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.data.pon_ports
                - type: JAVASCRIPT
                  parameters:
                    - 'var arr = value; if (typeof arr === "string") { arr = JSON.parse(arr); } if (!Array.isArray(arr)) { return 0; } var targetPon = "{#PONNAME}"; for (var i = 0; i < arr.length; i++) { if (arr[i].pon_name == targetPon) { return Number(arr[i].provisioned); } } return 0;'
              master_item:
                key: 'fiberhome_olt_status.py[{HOST.CONN},{$OLT_USER},{$OLT_PASSWORD},{$OLT_PORT}]'
              tags:
                - tag: Application
                  value: 'PON Status'
          graph_prototypes:
            - uuid: 1a038374246440268584825946394242
              name: 'Sinais Ópticos - PON {#PONNAME}'
              graph_items:
                - color: 00FF00
                  item:
                    host: Template_OLT_Fiberhome_RP1000
                    key: 'OntBestSinal.[{#PONNAME}]'
                - sortorder: '1'
                  color: 0000FF
                  item:
                    host: Template_OLT_Fiberhome_RP1000
                    key: 'OntMediaSinal.[{#PONNAME}]'
                - sortorder: '2'
                  color: FF0000
                  item:
                    host: Template_OLT_Fiberhome_RP1000
                    key: 'OntPoorSinal.[{#PONNAME}]'
            - uuid: 0b038374246440268584825946394243
              name: 'Status ONUs - PON {#PONNAME}'
              graph_items:
                - drawtype: FILLED_REGION
                  color: 00AA00
                  item:
                    host: Template_OLT_Fiberhome_RP1000
                    key: 'OntOnline.[{#PONNAME}]'
                - sortorder: '1'
                  drawtype: BOLD_LINE
                  color: FF0000
                  item:
                    host: Template_OLT_Fiberhome_RP1000
                    key: 'OntOffline.[{#PONNAME}]'
      macros:
        - macro: '{$OLT_PASSWORD}'
          value: GEPON
        - macro: '{$OLT_PORT}'
          value: '23'
        - macro: '{$OLT_USER}'
          value: GEPON
        - macro: '{$SNMP_COMMUNITY}'
          value: public
        - macro: '{$SNMP_PORT}'
          value: '161'
      valuemaps:
        - uuid: 79a0de01dc8f4e42b64a5a4475a2f26e
          name: 'IF-MIB::ifOperStatus'
          mappings:
            - value: '1'
              newvalue: up
            - value: '2'
              newvalue: down
            - value: '3'
              newvalue: testing
            - value: '4'
              newvalue: unknown
            - value: '5'
              newvalue: dormant
            - value: '6'
              newvalue: notPresent
            - value: '7'
              newvalue: lowerLayerDown
        - uuid: 07deb456903e464a89b939804820136d
          name: 'IF-MIB::ifType'
          mappings:
            - value: '6'
              newvalue: ethernetCsmacd
            - value: '62'
              newvalue: fastEther
            - value: '117'
              newvalue: gigabitEthernet
